# **Schoology Enhancer App \- Architectural Plan**

This document outlines the architecture for a web application integrating with Schoology via OAuth 1.0, utilizing Firebase Studio, GitHub, and Google Cloud services for development, deployment, and secure operation. It focuses on the technical structure and environment setup.

## **1\. System Overview**

The following systems are involved in the application's architecture:

* **Web Application (Frontend):** Next.js with React Server Components.
* **Backend:** Firebase Functions (Node.js) to handle server-side logic.
* **Database:** Firestore.
* **Schoology App Management:** The Schoology developer portal at `https://app.schoology.com/apps` is used to manage API credentials.
* **AI Agents (Gemini):** Used for code generation, debugging, and workflow automation.
*   **Vitest & Mock Service Worker (MSW):** Used for automated backend integration testing.

## **2\. OAuth 1.0 & Environment Strategy**

The application will implement the Schoology OAuth 1.0 "three-legged" authentication flow. A key challenge is managing the single, fixed Redirect URI required by Schoology across our different environments.

### **2.1. Two-App Registration Strategy**

To solve the Redirect URI constraint, we will maintain two separate application registrations in the Schoology developer portal:

1.  **`GradeWise (Dev)`**:
    *   **Purpose**: Used for all development and preview branch testing.
    *   **Credentials**: The current set of keys we have stored in Secret Manager (`SCHOOLOGY_CONSUMER_KEY`, `SCHOOLOGY_CONSUMER_SECRET`).
    *   **Redirect URI**: This field will be **manually updated** as needed to point to the temporary URLs generated by Firebase Hosting Preview Channels for live testing.

2.  **`GradeWise (Prod)`**:
    *   **Purpose**: Used exclusively by the live, production application.
    *   **Credentials**: A separate set of keys (`SCHOOLOGY_PROD_CONSUMER_KEY`, etc.) to be stored in Secret Manager.
    *   **Redirect URI**: A permanent, fixed URL pointing to the final production domain (e.g., `https://gradewise.web.app/api/auth/callback`).

### **2.2. OAuth Flow Steps & Testing**

1. **Request Token:** Our backend function initiates the request to Schoology.
2. **User Authorization:** The user is redirected to Schoology to grant permission.
3. **Callback & Access Token:** Schoology redirects the user back to the registered Redirect URI. Our backend function exchanges the temporary token for a permanent access token.

**For automated testing, this entire flow is mocked using MSW, so no live Redirect URI is needed.**

### **2.3. Key Management**

* All keys (both dev and prod sets) will be stored securely in Google Secret Manager.
* Our Firebase Functions will be configured to use the appropriate set of keys based on the environment they are running in (e.g., via environment variables).

## **3\. Data Management (Firestore)**

Firestore will serve as the primary database for user profiles and cached Schoology data. Security rules will ensure users can only access their own data.

## **4\. Development & Testing Workflow**

Our testing strategy is focused on rapid, AI-driven development.

*   **Backend Integration Tests:** We will use **Vitest** and **MSW** to run automated tests of the entire OAuth logic within the Firebase Studio terminal, providing instant feedback without requiring a browser or manual steps.
*   **Unit Tests:** Vitest will be used for testing smaller utility functions and components.
*   **Manual E2E Testing:** For full, live validation, we will deploy a branch to a Firebase Hosting Preview Channel and manually update the Redirect URI in the `GradeWise (Dev)` Schoology app to point to that channel's URL.

## **5\. IAM Permissions**

* The **Firebase Functions runtime service account** (`firebase-functions-sa@...`) requires the **Secret Manager Secret Accessor** and **Cloud Datastore User** roles.
